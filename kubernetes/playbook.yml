# ANSIBLE PLAYBOOK
#   $ ansible-playbook playbook.yml
- hosts: localhost
  vars:
    ansible_python_interpreter: python3
    ansible_connection_type: local
    NAMESPACE: opendebates-{{ ENVIRONMENT }}
    DATABASE_NAME: opendebates_{{ ENVIRONMENT }}
    DATABASE_USER: opendebates_{{ ENVIRONMENT }}
  tasks:
    - name: read vars from files
      # NOTE: vars in later files CAN change values of variables from earlier files
      include_vars:
        file: "{{ item }}"
      with_items:
      - "global_vars.yml"
      - "{{ ENVIRONMENT }}_secrets.yml"
      - "{{ ENVIRONMENT }}_vars.yml"

    - name: Override ansible_python_interpreter for virtualenv
      set_fact:
        ansible_python_interpreter: "{{ lookup('env', 'VIRTUAL_ENV') }}/bin/python"
      when: lookup('env','VIRTUAL_ENV')

    # https://kubernetes.github.io/ingress-nginx/
    # FIXME: this will be provided by caktus-hosting-services soon.
    - name: stuff needed to use nginx ingress controller
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml
    - name: now tell ingress-nginx to make a load balancer when needed
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/cloud-generic.yaml

    - name: create things in Kubernetes
      k8s:
        definition: "{{ lookup('template', item) }}"
        # Ensure we see any failures in CI
        wait: yes
        validate:
          fail_on_error: yes
          strict: yes
      with_items:
        - namespace.yaml.j2
        - opendebates_secrets.yaml.j2
        - django_config.yaml.j2
        - redis.yaml.j2
        - memcached.yaml.j2
        - opendebates.yaml.j2

    - name: run migrations
      shell: kubectl exec --namespace={{ NAMESPACE }} deployment/opendebates /venv/bin/python /code/manage.py migrate

    - name: create site
      shell: kubectl exec --namespace={{ NAMESPACE }} deployment/opendebates /venv/bin/python /code/manage.py create_site {{ DOMAIN }}
